<script>
    // === ALL YOUR ORIGINAL VARIABLES & ARRAYS (Audio, Achievements, GameState, Cards, etc.) STAY THE SAME ===
    // ... (keep sounds, achievements, gameState, missionCards, obstacleCards, powerUpCards, AIPlayer class) ...

    // FIXED: Complete 40-space boardLayout (was missing space 39)
    const boardLayout = [
        // Top row (0-9) + Corner 10
        { type: 'start', label: 'START', icon: 'ðŸ', corner: true },
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'community', label: 'COMMUNITY', icon: 'ðŸ¤' },
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'obstacle', label: 'BARRIER', icon: 'âš ï¸' },
        { type: 'investment', label: 'INVEST', icon: 'ðŸ’¹' },
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'powerup', label: 'POWER', icon: 'âš¡' },
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'community', label: 'COMMUNITY', icon: 'ðŸ¤' },
        { type: 'investment', label: 'FREE INVEST', icon: 'ðŸ’°', corner: true },  // Index 10

        // Right column (11-19)
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'obstacle', label: 'BARRIER', icon: 'âš ï¸' },
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'powerup', label: 'POWER', icon: 'âš¡' },
        { type: 'investment', label: 'INVEST', icon: 'ðŸ’¹' },
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'community', label: 'COMMUNITY', icon: 'ðŸ¤' },
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'obstacle', label: 'BARRIER', icon: 'âš ï¸' },  // Index 19

        // Bottom row (20-29) reversed + Corner 30
        { type: 'obstacle', label: 'MAJOR BARRIER', icon: 'ðŸš«', corner: true },  // Index 20
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'powerup', label: 'POWER', icon: 'âš¡' },
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'investment', label: 'INVEST', icon: 'ðŸ’¹' },
        { type: 'community', label: 'COMMUNITY', icon: 'ðŸ¤' },
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'obstacle', label: 'BARRIER', icon: 'âš ï¸' },
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'powerup', label: 'POWER', icon: 'âš¡' },
        { type: 'powerup', label: 'MEGA POWER', icon: 'ðŸŒŸ', corner: true },  // Index 30

        // Left column (31-39) going up
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'obstacle', label: 'BARRIER', icon: 'âš ï¸' },
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'community', label: 'COMMUNITY', icon: 'ðŸ¤' },
        { type: 'investment', label: 'INVEST', icon: 'ðŸ’¹' },
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'powerup', label: 'POWER', icon: 'âš¡' },
        { type: 'grant', label: 'GRANT', icon: 'ðŸ“‹' },
        { type: 'obstacle', label: 'BARRIER', icon: 'âš ï¸' }  // Index 39 - NOW COMPLETE!
    ];

    // === YOUR ORIGINAL FUNCTIONS (initAudio, playSound, toggleSound, etc.) STAY THE SAME ===
    // ... (keep up to showHelp) ...

    // FIXED: createBoard() with robust 40-space grid positioning
    function createBoard() {
        const boardElement = document.getElementById('gameBoard');
        boardElement.innerHTML = '';
        gameState.board = boardLayout;  // Now exactly 40 spaces

        boardLayout.forEach((space, index) => {
            const spaceElement = document.createElement('div');
            spaceElement.className = `board-space space-${space.type} ${space.corner ? 'corner-space' : ''}`;
            spaceElement.id = `space-${index}`;

            // FIXED Monopoly-style positioning (handles corners properly)
            if (index === 0) {  // Bottom-left corner
                spaceElement.style.gridColumn = '1 / span 2';
                spaceElement.style.gridRow = '11 / span 2';
            } else if (index === 10) {  // Bottom-right corner
                spaceElement.style.gridColumn = '11 / span 2';
                spaceElement.style.gridRow = '11 / span 2';
            } else if (index === 20) {  // Top-right corner
                spaceElement.style.gridColumn = '11 / span 2';
                spaceElement.style.gridRow = '1 / span 2';
            } else if (index === 30) {  // Top-left corner
                spaceElement.style.gridColumn = '1 / span 2';
                spaceElement.style.gridRow = '1 / span 2';
            } else if (index <= 9) {  // Top row (left to right)
                spaceElement.style.gridColumn = (index + 3);  // Offset for corners
                spaceElement.style.gridRow = 3;
            } else if (index <= 19) {  // Right column (top to bottom)
                spaceElement.style.gridColumn = 11;
                spaceElement.style.gridRow = (index - 9 + 1);
            } else if (index <= 29) {  // Bottom row (right to left)
                spaceElement.style.gridColumn = (40 - index);
                spaceElement.style.gridRow = 11;
            } else {  // Left column (bottom to top)
                spaceElement.style.gridColumn = 1;
                spaceElement.style.gridRow = (70 - index);  // Adjusted for 11x11
            }

            spaceElement.innerHTML = `
                <div class="space-icon">${space.icon}</div>
                <div class="space-label">${space.label}</div>
            `;
            spaceElement.onclick = () => showSpaceInfo(index, space);
            boardElement.appendChild(spaceElement);
        });

        // FIXED: Center area (dice/buttons) - append after spaces
        const centerElement = document.createElement('div');
        centerElement.className = 'board-center';
        centerElement.style.gridColumn = '3 / 10';
        centerElement.style.gridRow = '3 / 10';
        centerElement.innerHTML = `
            <div class="center-logo">BLEU</div>
            <div class="dice-container" id="diceContainer"></div>
            <div style="display: flex; gap: 10px;">
                <button class="action-button" onclick="rollDice()" id="rollBtn">ROLL DICE</button>
                <button class="action-button secondary" onclick="endTurn()" id="endTurnBtn" disabled>END TURN</button>
            </div>
        `;
        boardElement.appendChild(centerElement);
    }

    // === YOUR ORIGINAL FUNCTIONS (createPlayers, initializeAchievements, etc.) STAY THE SAME ===
    // ... (keep updatePlayerDisplay, placePlayerTokens, rollDice [add console.log for debugging], handleSpaceEffect [add type check], etc.) ...

    // In rollDice(): Add this safeguard after position update
    // const currentSpace = gameState.board[currentPlayer.position] || { type: 'start', label: 'Unknown' };
    // if (!currentSpace.type) console.error('Missing space at position:', currentPlayer.position);  // Debug

    // FIXED: initializeGame() - Now creates board FIRST
    function initializeGame() {
        createBoard();  // Ensure board renders before players
        updatePlayerDisplay();
        placePlayerTokens();
        initializeAchievements();
        gameState.gameActive = true;
        gameState.diceRolled = false;
        updateDisplay();
        addLogEntry("ðŸŽ® Game initialized! Roll the dice to begin!");
        showNotification("Game Started!", 2000);
        document.getElementById('endTurnBtn').disabled = true;  // Start disabled
    }

    // === PLAYER SELECTION MODAL HTML (ADD THIS BEFORE <script> IF NOT ALREADY) ===
    // <div class="modal active" id="playerSetupModal"> ... (as in previous response) ...

    // FIXED: startGameWithPlayers() - Clean transition + init
    function startGameWithPlayers(count) {
        gameState.players = [];
        for (let i = 0; i < count; i++) {
            const name = document.getElementById(`pname${i}`)?.value.trim() || `Player ${i+1}`;
            gameState.players.push({
                name, color: colors[i % colors.length], avatar: avatars[i % avatars.length],
                wealth: 10, resources: 3, position: 0, skipTurns: 0, powerUps: [], isAI: false
            });
        }
        if (gameState.aiEnabled) {
            gameState.players.push({ name: "AI Player", color: "#ff00ff", avatar: "ðŸ¤–", wealth: 10, resources: 3, position: 0, skipTurns: 0, powerUps: [], isAI: true });
        }
        document.getElementById('playerSetupModal').classList.remove('active');  // HIDE MODAL
        setTimeout(initializeGame, 300);  // Slight delay for smooth render
    }

    // === FIXED: window.onload - Only setup modal, no auto-game ===
    window.onload = () => {
        // Define avatars/colors if not already (add at top if missing)
        const avatars = ['ðŸ‘¤', 'ðŸ‘©', 'ðŸ‘¨', 'ðŸ‘¦', 'ðŸŽ¨', 'ðŸ”¬', 'ðŸ“š', 'ðŸ”§'];
        const colors = ['#00ffcc', '#ff00ff', '#00ff88', '#ffaa00', '#8888ff', '#ff6666', '#ffff66', '#66ccff'];
        initializeAchievements();  // Just achievements for modal
        addLogEntry("ðŸŽ¯ Setup players to begin!");
        // Player modal auto-shows via class='active'
    };

    // In handleSpaceEffect(): Add fallback
    function handleSpaceEffect(space) {
        if (!space || !space.type) {
            console.error('Invalid space:', space);  // Debug log
            return showModal('Error', 'Invalid board space - restart game?');
        }
        // ... rest unchanged ...
    }

    // === ALL OTHER FUNCTIONS (attemptMission, etc.) STAY THE SAME ===
</script>
