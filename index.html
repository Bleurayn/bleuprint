<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Your existing <head> with all the beautiful CSS stays 100% the same -->
    <!-- ... keep everything until </style> ... -->
</head>
<body>
    <!-- Your existing HTML structure until the end of .game-container -->

    <!-- ADD THIS MODAL FOR PLAYER SELECTION -->
    <div class="modal active" id="playerSetupModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">Player Setup</div>
            <div class="modal-body">
                <p>How many players? (1–4)</p>
                <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0;">
                    <button class="action-button" onclick="setupPlayers(1)">1 Player</button>
                    <button class="action-button" onclick="setupPlayers(2)">2 Players</button>
                    <button class="action-button" onclick="setupPlayers(3)">3 Players</button>
                    <button class="action-button" onclick="setupPlayers(4)">4 Players</button>
                </div>
                <div id="playerNameInputs" style="margin-top: 20px; display: none;">
                    <p>Enter player names:</p>
                    <!-- Will be filled dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Your existing modals and toast stay the same -->
    <div class="modal" id="gameModal">...</div>
    <div class="notification-toast" id="notificationToast"></div>

    <script>
        // === ALL YOUR EXISTING CODE UNTIL boardLayout ===

        // FIXED: Full 40-space board (Monopoly standard)
        const boardLayout = [
            // Corner 0
            { type: 'start', label: 'START', icon: 'Start', corner: true },
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'community', label: 'COMMUNITY', icon: 'Handshake' },
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'obstacle', label: 'BARRIER', icon: 'Warning' },
            { type: 'investment', label: 'INVEST', icon: 'ChartIncreasing' },
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'powerup', label: 'POWER', icon: 'Lightning' },
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'community', label: 'COMMUNITY', icon: 'Handshake' },
            { type: 'investment', label: 'FREE INVEST', icon: 'Money', corner: true }, // 10

            // Right side
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'obstacle', label: 'BARRIER', icon: 'Warning' },
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'powerup', label: 'POWER', icon: 'Lightning' },
            { type: 'investment', label: 'INVEST', icon: 'ChartIncreasing' },
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'community', label: 'COMMUNITY', icon: 'Handshake' },
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'obstacle', label: 'BARRIER', icon: 'Warning' }, // 19

            // Bottom-right corner
            { type: 'obstacle', label: 'MAJOR BARRIER', icon: 'Prohibited', corner: true },
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'powerup', label: 'POWER', icon: 'Lightning' },
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'investment', label: 'INVEST', icon: 'ChartIncreasing' },
            { type: 'community', label: 'COMMUNITY', icon: 'Handshake' },
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'obstacle', label: 'BARRIER', icon: 'Warning' },
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'powerup', label: 'POWER', icon: 'Lightning' },
            { type: 'powerup', label: 'MEGA POWER', icon: 'Star', corner: true }, // 30

            // Left side
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'obstacle', label: 'BARRIER', icon: 'Warning' },
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'community', label: 'COMMUNITY', icon: 'Handshake' },
            { type: 'investment', label: 'INVEST', icon: 'ChartIncreasing' },
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'powerup', label: 'POWER', icon: 'Lightning' },
            { type: 'grant', label: 'GRANT', icon: 'Document' },
            { type: 'obstacle', label: 'BARRIER', icon: 'Warning' }  // 39
        ];

        // Player avatars & colors
        const avatars = ['Person', 'Woman', 'Man', 'Child', 'Artist', 'Scientist', 'Student', 'Engineer'];
        const colors = ['#00ffcc', '#ff00ff', '#00ff88', '#ffaa00', '#8888ff', '#ff6666', '#ffff66', '#66ccff'];

        // === PLAYER SELECTION ===
        function setupPlayers(count) {
            const container = document.getElementById('playerNameInputs');
            container.style.display = 'block';
            container.innerHTML = '<p>Enter player names:</p>';

            for (let i = 0; i < count; i++) {
                const div = document.createElement('div');
                div.style.margin = '10px 0';
                div.innerHTML = `
                    <label>Player ${i+1}:</label>
                    <input type="text" id="pname${i}" value="Player ${i+1}" style="padding:5px; margin-left:10px; background:#1a1f3a; border:1px solid #00ffcc; color:#00ffcc; border-radius:5px;">
                    <span style="margin-left:10px;">Avatar: ${avatars[i]}</span>
                `;
                container.appendChild(div);
            }

            const startBtn = document.createElement('button');
            startBtn.className = 'action-button';
            startBtn.textContent = 'START GAME';
            startBtn.onclick = () => startGameWithPlayers(count);
            container.appendChild(startBtn);
        }

        function startGameWithPlayers(count) {
            gameState.players = [];
            for (let i = 0; i < count; i++) {
                const name = document.getElementById(`pname${i}`).value.trim() || `Player ${i+1}`;
                gameState.players.push({
                    name,
                    color: colors[i],
                    avatar: avatars[i],
                    wealth: 10,
                    resources: 3,
                    position: 0,
                    skipTurns: 0,
                    powerUps: [],
                    isAI: false
                });
            }
            // Optionally add AI as last player
            if (gameState.aiEnabled && count < 4) {
                gameState.players.push({
                    name: "AI Opponent",
                    color: "#ff00ff",
                    avatar: "Robot",
                    wealth: 10,
                    resources: 3,
                    position: 0,
                    skipTurns: 0,
                    powerUps: [],
                    isAI: true
                });
            }

            document.getElementById('playerSetupModal').classList.remove('active');
            initializeGame();
        }

        // === FIX: createBoard now handles all 40 spaces correctly ===
        function createBoard() {
            const boardElement = document.getElementById('gameBoard');
            boardElement.innerHTML = '';
            gameState.board = boardLayout; // now exactly 40

            boardLayout.forEach((space, index) => {
                const spaceEl = document.createElement('div');
                spaceEl.className = `board-space space-${space.type} ${space.corner ? 'corner-space' : ''}`;
                spaceEl.id = `space-${index}`;

                // Proper Monopoly grid positioning
                if (index === 0) {
                    spaceEl.style.gridArea = '1 / 1 / 3 / 3';
                } else if (index === 10) {
                    spaceEl.style.gridArea = '1 / 10 / 3 / 12';
                } else if (index === 20) {
                    spaceEl.style.gridArea = '10 / 10 / 12 / 12';
                } else if (index === 30) {
                    spaceEl.style.gridArea = '10 / 1 / 12 / 3';
                } else if (index < 10) {
                    spaceEl.style.gridColumn = index + 2;
                    spaceEl.style.gridRow = 1;
                } else if (index < 20) {
                    spaceEl.style.gridColumn = 11;
                    spaceEl.style.gridRow = index - 8;
                } else if (index < 30) {
                    spaceEl.style.gridColumn = 31 - index;
                    spaceEl.style.gridRow = 11;
                } else {
                    spaceEl.style.gridColumn = 1;
                    spaceEl.style.gridRow = 41 - index;
                }

                spaceEl.innerHTML = `
                    <div class="space-icon">${space.icon}</div>
                    <div class="space-label">${space.label}</div>
                `;
                spaceEl.onclick = () => showSpaceInfo(index, space);
                boardElement.appendChild(spaceEl);
            });

            // Center
            const center = document.createElement('div');
            center.className = 'board-center';
            center.innerHTML = `...`; // same as before
            boardElement.appendChild(center);
        }

        // === FIX: position is now correctly modulo 40 and board has 40 spaces ===
        // In rollDice():
        currentPlayer.position = (currentPlayer.position + total) % 40; // SAFE

        // === Everything else stays the same ===

        // Start with player selection screen
        window.onload = () => {
            // Don't auto-start — show player setup
            createBoard();
            initializeAchievements();
            addLogEntry("Welcome! Choose number of players to begin.");
        };
    </script>
</body>
</html>
